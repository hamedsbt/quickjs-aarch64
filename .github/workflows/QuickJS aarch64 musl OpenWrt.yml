name: Build QuickJS for OpenWrt (bcm2711 / aarch64)

on:
  workflow_dispatch:

env:
  OPENWRT_SDK_URL: "https://downloads.openwrt.org/releases/24.10.5/targets/bcm27xx/bcm2711/openwrt-sdk-24.10.5-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
  QUICKJS_VERSION: "2025-09-13"  # informational only

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install prerequisites
      run: |
        sudo apt-get update -y
        sudo apt-get install -y wget xz-utils zstd build-essential file python3 rsync

    - name: Download OpenWrt SDK
      run: |
        set -euo pipefail
        echo "Downloading OpenWrt SDK..."
        wget --progress=dot:giga "$OPENWRT_SDK_URL" -O openwrt-sdk.tar.zst
        tar --zstd -xf openwrt-sdk.tar.zst
        SDK_DIR="$(ls -d openwrt-sdk-* | head -n1)"
        if [ -z "$SDK_DIR" ]; then
          echo "ERROR: SDK extraction failed"
          ls -la
          exit 1
        fi
        echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV
        ls -ld "$SDK_DIR"

    - name: Configure toolchain & sysroot
      run: |
        set -euo pipefail
        STAGING="$PWD/$SDK_DIR/staging_dir"

        TOOLCHAIN_DIR="$(find "$STAGING" -maxdepth 1 -type d -name 'toolchain-aarch64*' | head -n1)"
        SYSROOT_DIR="$(find "$STAGING" -maxdepth 1 -type d -name 'target-aarch64*' | head -n1)"

        if [ -z "$TOOLCHAIN_DIR" ] || [ -z "$SYSROOT_DIR" ]; then
          echo "ERROR: toolchain or sysroot not found in $STAGING"
          ls -la "$STAGING" || true
          exit 1
        fi

        echo "TOOLCHAIN=$TOOLCHAIN_DIR" >> $GITHUB_ENV
        echo "SYSROOT=$SYSROOT_DIR" >> $GITHUB_ENV
        echo "STAGING_DIR=$STAGING" >> $GITHUB_ENV

        export PATH="$TOOLCHAIN_DIR/bin:$PATH"
        aarch64-openwrt-linux-gcc --version || true

    - name: Apply safe local patches & write config.h
      run: |
        set -euo pipefail

        # Small safe fixes
        sed -i 's/signal(SIGPIPE, SIG_IGN);/signal(SIGPIPE, (void (*)(int))SIG_IGN);/' quickjs-libc.c || true
        grep -q 'extern char \*\*environ;' quickjs-libc.c || \
          sed -i '/#include <stdlib.h>/a extern char **environ;' quickjs-libc.c || true

        # create config.h
        cat > config.h <<'EOF'
        #ifndef CONFIG_H
        #define CONFIG_H
        #define CONFIG_VERSION "0"
        #endif
        EOF
        ls -l config.h

    - name: Phase 1 — build native host qjsc (isolated)
      run: |
        set -euo pipefail
        HOSTBUILD="$(mktemp -d /tmp/quickjs-host-XXXX)"
        echo "Host build dir: $HOSTBUILD"
        rsync -a --exclude='.git' ./ "$HOSTBUILD/"

        cd "$HOSTBUILD"
        rm -rf .obj *.o *.a qjs qjsc host-qjsc libquickjs.a || true

        make -j$(nproc) CC=gcc qjsc

        if [ ! -x qjsc ]; then
          echo "Host qjsc build failed"
          exit 1
        fi
        
        cp qjsc "$GITHUB_WORKSPACE/host-qjsc"
        chmod +x "$GITHUB_WORKSPACE/host-qjsc"
        file "$GITHUB_WORKSPACE/host-qjsc"
        
        cd /
        rm -rf "$HOSTBUILD"

    - name: Phase 2 — cross-build for OpenWrt aarch64
      env:
        TOOLCHAIN: ${{ env.TOOLCHAIN }}
        SYSROOT: ${{ env.SYSROOT }}
        STAGING_DIR: ${{ env.STAGING_DIR }}
      run: |
        set -euo pipefail

        rm -rf .obj *.o *.a qjs qjsc libquickjs.a examples/*.o examples/*.so examples/*.c || true
        test -x ./host-qjsc || (echo "ERROR: host-qjsc missing" && exit 1)

        CROSS_PREFIX="${TOOLCHAIN}/bin"
        CROSS_CC="${CROSS_PREFIX}/aarch64-openwrt-linux-gcc"
        CROSS_AR="${CROSS_PREFIX}/aarch64-openwrt-linux-ar"
        CROSS_RANLIB="${CROSS_PREFIX}/aarch64-openwrt-linux-ranlib"
        CROSS_STRIP="${CROSS_PREFIX}/aarch64-openwrt-linux-strip"

        echo "Using CROSS_CC=${CROSS_CC}"
        "${CROSS_CC}" --version

        CFLAGS="--sysroot=${SYSROOT} -Os -pipe -ffunction-sections -fdata-sections -include config.h -D_GNU_SOURCE -D_DEFAULT_SOURCE"
        CPPFLAGS="-I${SYSROOT}/usr/include -I."
        LDFLAGS="--sysroot=${SYSROOT} -Wl,--gc-sections"
        export STAGING_DIR="${STAGING_DIR}"

        make -j$(nproc) \
          CC="${CROSS_CC}" \
          AR="${CROSS_AR}" \
          RANLIB="${CROSS_RANLIB}" \
          STRIP="${CROSS_STRIP}" \
          CFLAGS="${CFLAGS}" \
          CPPFLAGS="${CPPFLAGS}" \
          LDFLAGS="${LDFLAGS}" \
          QJSC=./host-qjsc \
          CONFIG_CROSS=y \
          PROGS="qjs qjsc libquickjs.a"

        ls -lah qjs qjsc libquickjs.a host-qjsc || true
        file qjs qjsc host-qjsc || true
        readelf -h qjs || true

    - name: Strip and package artifacts
      run: |
        set -euo pipefail

        if [ -x "${{ env.TOOLCHAIN }}/bin/aarch64-openwrt-linux-strip" ]; then
          "${{ env.TOOLCHAIN }}/bin/aarch64-openwrt-linux-strip" qjs qjsc || true
        fi

        mkdir -p artifacts
        cp -a qjs qjsc libquickjs.a host-qjsc artifacts/
        printf "QuickJS (built for OpenWrt aarch64)\n" > artifacts/README.txt
        ls -lh artifacts

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: quickjs-openwrt-aarch64
        path: artifacts/
