name: Build QuickJS (aarch64 musl OpenWrt)

on:
  workflow_dispatch:

env:
  OPENWRT_SDK_URL: "https://downloads.openwrt.org/releases/24.10.5/targets/bcm27xx/bcm2711/openwrt-sdk-24.10.5-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
  QUICKJS_REPO: "https://github.com/your-username/quickjs-aarch64-musl.git"
  QUICKJS_BRANCH: "main"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Prepare runner
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget xz-utils zstd build-essential git file


      - name: Checkout QuickJS fork
        uses: actions/checkout@v4
        with:
          repository: hamedsbt/quickjs-aarch64
          ref: master
          path: quickjs
          
      - name: Download OpenWrt SDK
        run: |
          set -euo pipefail
          wget -q --show-progress "$OPENWRT_SDK_URL" -O openwrt-sdk.tar.zst
          tar --zstd -xf openwrt-sdk.tar.zst
          SDK_DIR="$(ls -d openwrt-sdk-* | head -n1)"
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

      - name: Setup OpenWrt toolchain
        run: |
          set -euo pipefail
          STAGING="$PWD/${{ env.SDK_DIR }}/staging_dir"
          TOOLCHAIN=$(find "$STAGING" -maxdepth 1 -type d -name 'toolchain-aarch64*' | head -n1)
          SYSROOT=$(find "$STAGING" -maxdepth 1 -type d -name 'target-aarch64*' | head -n1)
          export PATH="$TOOLCHAIN/bin:$PATH"
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV

      - name: Create config.h
        run: |
          cd "${{ env.QUICKJS_DIR }}"
          cat > config.h <<'EOF'
          #ifndef CONFIG_H
          #define CONFIG_H
          #define CONFIG_VERSION "0"
          #endif
          EOF

      - name: Build QuickJS (OpenWrt aarch64) â€” force config.h inclusion
        run: |
          set -euo pipefail
      
          # 1) go to source (assumes checkout to 'quickjs')
          cd quickjs
      
          # 2) create config.h (safe; string literal)
          cat > config.h <<'EOF'
          #ifndef CONFIG_H
          #define CONFIG_H
          #define CONFIG_VERSION "0"
          #endif
          EOF
      
          # 3) cleanup upstream build artifacts
          rm -rf .obj *.o *.a qjs qjsc libquickjs.a || true
      
          # 4) toolchain paths (provided by earlier steps)
          CROSS_PREFIX="${TOOLCHAIN}/bin"
          CROSS_CC="${CROSS_PREFIX}/aarch64-openwrt-linux-gcc"
          CROSS_AR="${CROSS_PREFIX}/aarch64-openwrt-linux-ar"
          CROSS_RANLIB="${CROSS_PREFIX}/aarch64-openwrt-linux-ranlib"
          CROSS_STRIP="${CROSS_PREFIX}/aarch64-openwrt-linux-strip"
      
          # 5) sysroot + flags
          SYSROOT="${SYSROOT}"
          # IMPORTANT: put -include config.h into CFLAGS so the Makefile's compiler calls definitely see it
          CFLAGS="--sysroot=${SYSROOT} -Os -pipe -ffunction-sections -fdata-sections -include config.h -D_GNU_SOURCE -D_DEFAULT_SOURCE"
          LDFLAGS="--sysroot=${SYSROOT} -Wl,--gc-sections"
          CPPFLAGS="-I${SYSROOT}/usr/include -I."
      
          # 6) sanity
          echo "Using CROSS_CC=${CROSS_CC}"
          "${CROSS_CC}" --version || true
          pwd
          ls -la | sed -n '1,120p'
          test -f Makefile || (echo "Makefile not found" && exit 1)
      
          # 7) build (pass the cross tools and flags on the make command line)
          make -j$(nproc) \
            CC="${CROSS_CC}" \
            AR="${CROSS_AR}" \
            RANLIB="${CROSS_RANLIB}" \
            STRIP="${CROSS_STRIP}" \
            CFLAGS="${CFLAGS}" \
            CPPFLAGS="${CPPFLAGS}" \
            LDFLAGS="${LDFLAGS}"
      
          # 8) show artifacts
          ls -lh qjs qjsc libquickjs.a || true


      - name: Strip and verify
        run: |
          cd "${{ env.QUICKJS_DIR }}"
          "${{ env.TOOLCHAIN }}/bin/aarch64-openwrt-linux-strip" qjs qjsc || true
          file qjs qjsc || true

      - name: Package artifacts
        run: |
          cd "${{ env.QUICKJS_DIR }}"
          mkdir -p artifacts
          cp qjs qjsc libquickjs.a artifacts/
          printf "QuickJS (aarch64 OpenWrt)\n" > artifacts/README.txt
          ls -lh artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quickjs-openwrt-aarch64
          path: artifacts/
